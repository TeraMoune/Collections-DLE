<?xml version="1.0" encoding="utf-8"?>
<dleplugin>
	<name>Collections</name>
	<description>Подборки для DataLife Engine.</description>
	<icon></icon>
	<version></version>
	<dleversion>14</dleversion>
	<versioncompare>greater</versioncompare>
	<upgradeurl></upgradeurl>
	<filedelete>1</filedelete>
	<needplugin></needplugin>
	<mnotice>1</mnotice>
	<mysqlinstall><![CDATA[CREATE TABLE {prefix}_news_collections (
  `id` int(11) NOT NULL auto_increment,
  `user_name` varchar(100) NOT NULL DEFAULT '',
  `name` varchar(255) NOT NULL DEFAULT '',
  `alt_url` varchar(190) NOT NULL DEFAULT '',
  `descr` text NOT NULL,
  `num_elem` int(11) NOT NULL DEFAULT '0',
  `news_read` int(11) NOT NULL DEFAULT '0',
  `news_rating` int(11) NOT NULL DEFAULT '0',
  `news_vote` int(11) NOT NULL DEFAULT '0',
  `news_comm` int(11) NOT NULL DEFAULT '0',
  `date` datetime NOT NULL DEFAULT '1970-01-01 01:00:00',
  `create_date` datetime NOT NULL DEFAULT '1970-01-01 01:00:00',
  `cover` varchar(255) NOT NULL DEFAULT '',
  `news_ids` text NOT NULL,
  `current_tags` text NOT NULL,
  `current_xfields` text NOT NULL,
  `keywords` text NOT NULL,
  `metatitle` varchar(255) NOT NULL DEFAULT '',
  `metadescr` varchar(300) NOT NULL DEFAULT '',
  `xfields_s` varchar(3) NOT NULL Default 'AND',
  `tags_s` varchar(3) NOT NULL Default 'AND',
  PRIMARY KEY (`id`),
  KEY `user_name` (`user_name`),
  KEY `name` (`name`),
  KEY `alt_url` (`alt_url`)
) ENGINE=InnoDB DEFAULT CHARACTER SET {charset} COLLATE {charset}_general_ci;

ALTER TABLE `{prefix}_post` ADD `collections` varchar(190) NOT NULL DEFAULT '0' AFTER `category`;
ALTER TABLE `{userprefix}_users` ADD `favorites_collections` text NOT NULL;
ALTER TABLE `{prefix}_usergroups` ADD `collections_allow_edit` tinyint(1) NOT NULL DEFAULT '0';
INSERT INTO `{prefix}_admin_sections` (`name`, `title`, `descr`, `icon`, `allow_groups`) VALUES ('news_collections', 'Подборки новостей', '', '', '1');]]></mysqlinstall>
	<mysqlupgrade><![CDATA[ALTER TABLE `dle_news_collections` ADD `news_read` int(11) NOT NULL Default 0 AFTER `num_elem`, ADD `news_rating` int(11) NOT NULL Default 0 AFTER `num_elem`, ADD `news_vote` int(11) NOT NULL Default 0 AFTER `num_elem`, ADD `news_comm` int(11) NOT NULL Default 0 AFTER `num_elem`, ADD `xfields_s` varchar(3) NOT NULL Default 'AND', ADD `tags_s` varchar(3) NOT NULL Default 'AND';]]></mysqlupgrade>
	<mysqlenable><![CDATA[]]></mysqlenable>
	<mysqldisable><![CDATA[]]></mysqldisable>
	<mysqldelete><![CDATA[DROP TABLE IF EXISTS {prefix}_news_collections;
ALTER TABLE `{prefix}_post` DROP `collections`;
ALTER TABLE `{userprefix}_users` DROP `favorites_collections`;
ALTER TABLE `{prefix}_usergroups` DROP `collections_allow_edit`;
DELETE FROM `{prefix}_admin_sections` WHERE name = 'news_collections';]]></mysqldelete>
	<phpinstall><![CDATA[$db->query("UPDATE ".PREFIX."_usergroups SET collections_allow_edit = 1 WHERE id = 1");]]></phpinstall>
	<phpupgrade><![CDATA[]]></phpupgrade>
	<phpenable><![CDATA[]]></phpenable>
	<phpdisable><![CDATA[]]></phpdisable>
	<phpdelete><![CDATA[]]></phpdelete>
	<notice><![CDATA[Email: teramoune@gmail.com, 
Git: https://github.com/TeraMoune/Collections-DLE]]></notice>
	<file name="engine/engine.php">
		<operation action="after">
			<searchcode><![CDATA[elseif ($do == 'stats') $nam_e = $lang['title_stats'];]]></searchcode>
			<replacecode><![CDATA[elseif ($do == 'collections') {
	$nam_e = $config['collection_speedbar'];
	if ( $collections_id ) {
      
		if( $seo_tags ) $metatags['keywords'] = $seo_tags;
		$metatags['header_title'] = $seo_title;
		$metatags['description'] = $seo_descr;
		$titl_e = $c_title;
 
		if ( ( isset($_GET['cstart']) AND intval($_GET['cstart']) > 1 ) ){

		if ( isset($_GET['cstart']) AND intval($_GET['cstart']) > 1 ) $titl_e .= ' &raquo; '.$lang['news_site'].' '.intval($_GET['cstart']);
		else $titl_e .= ' &raquo; '.$lang['news_site'].' '.intval($_GET['news_page']);

		}
 
	} else {
      

		$metatags['keywords'] = $config['collection_keywords'];
		$metatags['header_title'] = $config['collection_title'];
		$metatags['description'] = $config['collection_description'];
		
		if( $_GET['action'] == 'favorites' ) $titl_e = 'Закладки';
		
		if ( ( isset($_GET['cstart']) AND intval($_GET['cstart']) > 1 ) ){
			
		if( $_GET['action'] == 'favorites' ) $titl_e .= ' &raquo; ';
		if ( isset($_GET['cstart']) AND intval($_GET['cstart']) > 1 ) $titl_e .= $lang['news_site'].' '.intval($_GET['cstart']);
		else $titl_e .= $lang['news_site'].' '.intval($_GET['news_page']);

		}		
	} 
  
	if( $config['collection_disable_index'] ) $disable_index = true;
	$view_template = false;
}]]></replacecode>
		</operation>
		<operation action="replace">
			<searchcode><![CDATA[} elseif ($nam_e) $s_navigation .= " {$config['speedbar_separator']} " . $nam_e;]]></searchcode>
			<replacecode><![CDATA[} elseif ( $do =='collections' AND ( $collections_id OR $is_fav OR isset($_GET['cstart']) AND intval($_GET['cstart']) > 1 ) ) {
  
		if ($config['allow_alt_url']) $s_navigation .= " {$config['speedbar_separator']} <span itemprop=\"itemListElement\" itemscope itemtype=\"https://schema.org/ListItem\"><a href=\"" . $config['http_home_url'] . "collections/\" itemprop=\"url\"><span itemprop=\"title\">{$config['collection_speedbar']}</span></a></span>";
		else $s_navigation .= " {$config['speedbar_separator']} <span itemprop=\"itemListElement\" itemscope itemtype=\"https://schema.org/ListItem\"><a href=\"?do=collections\" itemprop=\"url\"><span itemprop=\"title\">{$config['collection_speedbar']}</span></a></span>";	

} elseif ($nam_e) $s_navigation .= " {$config['speedbar_separator']} " . $nam_e;]]></replacecode>
		</operation>
		<operation action="after">
			<searchcode><![CDATA[switch ( $do ) {]]></searchcode>
			<replacecode><![CDATA[case "collections" :
	include (DLEPlugins::Check(ENGINE_DIR . '/modules/news_collections.php'));
	break;]]></replacecode>
		</operation>
		<operation action="replace">
			<searchcode><![CDATA[p.allow_comm, p.fixed, p.tags,]]></searchcode>
			<replacecode><![CDATA[p.allow_comm, p.fixed, p.tags, p.collections,]]></replacecode>
		</operation>
	</file>
	<file name="engine/modules/show.short.php">
		<operation action="after">
			<searchcode><![CDATA[if( $category_id and $cat_info[$category_id]['short_tpl'] != '' ) $tpl->load_template( $cat_info[$category_id]['short_tpl'] . '.tpl' );]]></searchcode>
			<replacecode><![CDATA[elseif( $view_template == "collections" ) $tpl->load_template( 'shortstory_collections.tpl' );]]></replacecode>
		</operation>
		<operation action="before">
			<searchcode><![CDATA[$db->free( $sql_result );]]></searchcode>
			<replacecode><![CDATA[if( $view_template == "collections" ) $view_template = "";]]></replacecode>
		</operation>
		<operation action="after">
			<searchcode><![CDATA[if( !$view_template AND $count_all AND $config['news_navigation'] AND $news_found) {]]></searchcode>
			<replacecode><![CDATA[if( $do == 'collections' ) {
  
  if( $collections_id ) {
    if( $config['allow_alt_url'] ) $url_page .= '/' . $do . '/'.$collections_id . '-' . $collections['alt_url'];
    else $ucid = '?do=' . $do . '&id='.$collections_id;
  } else {
    if( $config['allow_alt_url'] ) $url_page .= '/' . $do;
    else $ucid = '?do=' . $do;
  }

} else $ucid = '';]]></replacecode>
		</operation>
		<operation action="replace">
			<searchcode><![CDATA[if ($user_query) $prev_page = $PHP_SELF . "?" . $user_query;
else $prev_page = $config['http_home_url'];]]></searchcode>
			<replacecode><![CDATA[if( $do == 'collections' ) {
  
	if ($user_query) $prev_page = $PHP_SELF . $ucid . $user_query;
	else $prev_page = $config['http_home_url'] . $ucid;
    
} else {
  
	if ($user_query) $prev_page = $PHP_SELF . "?" . $user_query;
	else $prev_page = $config['http_home_url']; 
  
}]]></replacecode>
		</operation>
		<operation action="replace">
			<searchcode><![CDATA[if ($user_query) $next = $PHP_SELF . "?cstart=" . $next_page . "&amp;" . $user_query;
else $next = $PHP_SELF . "?cstart=" . $next_page;]]></searchcode>
			<replacecode><![CDATA[if( $do == 'collections' ) {
  
	if ($user_query) $next = $PHP_SELF . $ucid . "&cstart=" . $next_page . "&amp;" . $user_query;
	else $next = $PHP_SELF . $ucid ."&cstart=" . $next_page;
    
} else {
  
	if ($user_query) $next = $PHP_SELF . "?cstart=" . $next_page . "&amp;" . $user_query;
	else $next = $PHP_SELF . "?cstart=" . $next_page;
  
}]]></replacecode>
		</operation>
		<operation action="replace">
			<searchcode><![CDATA[if ($j == 1)
	$pages .= "<a href=\"" . $url_page . "/\">$j</a> ";
else
	$pages .= "<a href=\"" . $url_page . "/page/" . $j . "/\">$j</a> ";]]></searchcode>
			<replacecode><![CDATA[if( $do == 'collections' ) {
  
	if ($j == 1)
		$pages .= "<a href=\"" . $url_page . "\">$j</a> ";
	else
		$pages .= "<a href=\"" . $url_page . "/page/" . $j . "\">$j</a> ";
    
} else {
  
	if ($j == 1)
		$pages .= "<a href=\"" . $url_page . "/\">$j</a> ";
	else
		$pages .= "<a href=\"" . $url_page . "/page/" . $j . "/\">$j</a> ";
  
}]]></replacecode>
		</operation>
		<operation action="replace">
			<searchcode><![CDATA[if ($user_query) {
	$pages .= "<a href=\"{$PHP_SELF}?{$user_query}\">$j</a> ";
} else $pages .= "<a href=\"{$config['http_home_url']}\">$j</a> ";]]></searchcode>
			<replacecode><![CDATA[if( $do == 'collections' ) {
  
	if ($user_query) {
		$pages .= "<a href=\"{$PHP_SELF}{$ucid}{$user_query}\">$j</a> ";
	} else $pages .= "<a href=\"{$config['http_home_url']}{$ucid}\">$j</a> ";
    
} else {
  
	if ($user_query) {
		$pages .= "<a href=\"{$PHP_SELF}?{$user_query}\">$j</a> ";
	} else $pages .= "<a href=\"{$config['http_home_url']}\">$j</a> ";
  
}]]></replacecode>
		</operation>
		<operation action="replace">
			<searchcode><![CDATA[if ($user_query) {
	$pages .= "<a href=\"$PHP_SELF?cstart=$j&amp;$user_query\">$j</a> ";
} else $pages .= "<a href=\"$PHP_SELF?cstart=$j\">$j</a> ";]]></searchcode>
			<replacecode><![CDATA[if( $do == 'collections' ) {
  
	if ($user_query) {
		$pages .= "<a href=\"$PHP_SELF{$ucid}&cstart=$j&amp;$user_query\">$j</a> ";
	} else $pages .= "<a href=\"$PHP_SELF{$ucid}&cstart=$j\">$j</a> ";
    
} else {
  
	if ($user_query) {
		$pages .= "<a href=\"$PHP_SELF?cstart=$j&amp;$user_query\">$j</a> ";
	} else $pages .= "<a href=\"$PHP_SELF?cstart=$j\">$j</a> ";
  
}]]></replacecode>
		</operation>
		<operation action="replace">
			<searchcode><![CDATA[if ($prev == 1)
	$prev_page = $url_page . "/";
else
	$prev_page = $url_page . "/page/" . $prev . "/";]]></searchcode>
			<replacecode><![CDATA[if( $do == 'collections' ) {
  
	if ($prev == 1)
		$prev_page = $url_page;
	else
		$prev_page = $url_page . "/page/" . $prev;
    
} else {
  
	if ($prev == 1)
		$prev_page = $url_page . "/";
	else
		$prev_page = $url_page . "/page/" . $prev . "/";
  
}]]></replacecode>
		</operation>
		<operation action="replace">
			<searchcode><![CDATA[if ($user_query) $prev_page = $PHP_SELF . "?cstart=" . $prev . "&amp;" . $user_query;
else $prev_page = $PHP_SELF . "?cstart=" . $prev;]]></searchcode>
			<replacecode><![CDATA[if( $do == 'collections' ) {
  
  if ($user_query) $prev_page = $PHP_SELF . $ucid ."&cstart=" . $prev . "&amp;" . $user_query;
  else $prev_page = $PHP_SELF . $ucid . "&cstart=" . $prev; 
  
} else {

  if ($user_query) $prev_page = $PHP_SELF . "?cstart=" . $prev . "&amp;" . $user_query;
  else $prev_page = $PHP_SELF . "?cstart=" . $prev;  
  
}]]></replacecode>
		</operation>
		<operation action="replace">
			<searchcode><![CDATA[$next = $url_page . '/page/' . $next_page . '/';]]></searchcode>
			<replacecode><![CDATA[if( $do == 'collections' ) $next = $url_page . '/page/' . $next_page;
else $next = $url_page . '/page/' . $next_page . '/';]]></replacecode>
		</operation>
		<operation action="replace">
			<searchcode><![CDATA[if( $cstart != $enpages_count ) {
						
	if( $config['allow_alt_url'] ) {
							
		$pages .= $nav_prefix . "<a href=\"" . $url_page . "/page/{$enpages_count}/\">{$enpages_count}</a>";
							
	} else {
							
		if ($user_query) $pages .= $nav_prefix . "<a href=\"$PHP_SELF?cstart={$enpages_count}&amp;$user_query\">{$enpages_count}</a>";
		else $pages .= $nav_prefix . "<a href=\"$PHP_SELF?cstart={$enpages_count}\">{$enpages_count}</a>";
							
	}
					
}]]></searchcode>
			<replacecode><![CDATA[if( $cstart != $enpages_count ) {
						
	if( $config['allow_alt_url'] ) {
							
		$pages .= $nav_prefix . "<a href=\"" . $url_page . "/page/{$enpages_count}/\">{$enpages_count}</a>";
							
	} else {
      
		if( $do == 'collections' ) {
          
          if ($user_query) $pages .= $nav_prefix . "<a href=\"$PHP_SELF{$ucid}&cstart={$enpages_count}&amp;$user_query\">{$enpages_count}</a>";
          else $pages .= $nav_prefix . "<a href=\"$PHP_SELF{$ucid}&cstart={$enpages_count}\">{$enpages_count}</a>";
          
        } else {
          
          if ($user_query) $pages .= $nav_prefix . "<a href=\"$PHP_SELF?cstart={$enpages_count}&amp;$user_query\">{$enpages_count}</a>";
          else $pages .= $nav_prefix . "<a href=\"$PHP_SELF?cstart={$enpages_count}\">{$enpages_count}</a>";
          
        }
	}
					
}]]></replacecode>
		</operation>
		<operation action="after">
			<searchcode><![CDATA[while ( $row = $db->get_row( $sql_result ) ) {]]></searchcode>
			<replacecode><![CDATA[if( $dle_module != 'collections' ) {
    if( !$row['collections'] ) {

        if( $row['tags'] OR $row['xfields'] ) search_collections();
        else {

            $tpl->set( '{collections-link}', $config['collection_speedbar'] . ': Не заданы' );
            $tpl->set( '{collections}', $config['collection_speedbar'] . ': Не заданы' );
            $tpl->set( '{owner-cnews-list}', '' );
            $tpl->set_block( "'\\[not-collections\\](.*?)\\[/not-collections\\]'si", "" );

        }

    } else {

        $collections_text = array ();
        $collections_link = array ();
        $collections_list = explode( ',', $row['collections'] );
        $config['collection_separator'] = $config['collection_separator'] ? $config['collection_separator'] : ',';	

        search_collections(1);

        $tpl->set( '{collections-link}', $config['collection_speedbar'] . ': ' . implode( " {$config['collection_separator']} ", $collections_link ) );
        $tpl->set( '{collections}', $config['collection_speedbar'] . ': ' . implode( " {$config['collection_separator']} ", $collections_text ) );
        $tpl->set( '[not-collections]', "" );
        $tpl->set( '[/not-collections]', "" );

    }
}]]></replacecode>
		</operation>
	</file>
	<file name="engine/modules/show.full.php">
		<operation action="before">
			<searchcode><![CDATA[$tpl->compile( 'content' );]]></searchcode>
			<replacecode><![CDATA[if( !$row['collections'] ) {
  
  	if( $row['tags'] OR $row['xfields'] ) search_collections();
  	else {
      
        $tpl->set( '{collections-link}', $config['collection_speedbar'] . ': Не заданы' );
        $tpl->set( '{collections}', $config['collection_speedbar'] . ': Не заданы' );
      	$tpl->set( '{owner-cnews-list}', '' );
        $tpl->set_block( "'\\[not-collections\\](.*?)\\[/not-collections\\]'si", "" );
      
    }
  
} else {
			
	$collections = array ();
	$collections_link = array ();
	$collections_list = explode( ',', $row['collections'] );
	$config['collection_separator'] = $config['collection_separator'] ? $config['collection_separator'] : ',';	
  	
  	search_collections(1);

    $tpl->set( '{collections-link}', $config['collection_speedbar'] . ': ' . implode( " {$config['collection_separator']} ", $collections_link ) );
   	$tpl->set( '{collections}', $config['collection_speedbar'] . ': ' . implode( " {$config['collection_separator']} ", $collections ) );
  	$tpl->set( '[not-collections]', "" );
	$tpl->set( '[/not-collections]', "" );

}

$c_allow = $user_group[$member_id['user_group']]['collections_allow_edit'];
		
if( !$c_allow AND $member_id['user_group'] != "1" ) {
  
	$tpl->set_block( "'\\[add-collections\\](.*?)\\[/add-collections\\]'si", "" );
  
} else {
  
  	$tpl->set( '[add-collections]', "<a href=\"javascript:editCollections('" . $row['id'] . "')\" title=\"Добавить в подборки\">" );
	$tpl->set( '[/add-collections]', "</a>" );
  
}]]></replacecode>
		</operation>
		<operation action="before">
			<searchcode><![CDATA[if (stripos ( $tpl->result['content'], "[hide" ) !== false ) {]]></searchcode>
			<replacecode><![CDATA[$ajax .= <<<HTML
<script>
function editCollections( id, action ){
	ShowLoading('');
	$.post(dle_root + 'engine/ajax/controller.php?mod=collections_menu', { news_id: id, action: action, user_hash: dle_login_hash }, function(data){
	
		if( data == 'error' ){
			alert(data);
		} else {
				  
			$.magnificPopup.open({
			items: {
				src: data
			},
			type: 'inline',
			mainClass: 'mfp-fade',
			removalDelay: 170,
			overflowY: 'hide',
			closeOnBgClick: true,
			showCloseBtn: true,
			callbacks: {
				open: function() {},
				afterClose: function() {},		 
				beforeClose: function() {}
			}		
			});					  
			
		}	
	
	HideLoading('');
	
	});

};
</script>
HTML;]]></replacecode>
		</operation>
	</file>
	<file name="engine/init.php">
		<operation action="after">
			<searchcode><![CDATA[$tpl->set( '{favorites-link}', $config['http_home_url'] . "favorites/" );]]></searchcode>
			<replacecode><![CDATA[$tpl->set( '{favorites-collections-link}', $config['http_home_url'] . "collections/favorites" );]]></replacecode>
		</operation>
		<operation action="after">
			<searchcode><![CDATA[$tpl->set( '{favorites-link}', $PHP_SELF . "?do=favorites" );]]></searchcode>
			<replacecode><![CDATA[$tpl->set( '{favorites-collections-link}', $PHP_SELF . "?do=collections&action=favorites" );]]></replacecode>
		</operation>
		<operation action="after">
			<searchcode><![CDATA[if( $config['start_site'] == 3 AND !$_SERVER['QUERY_STRING'] AND !$_POST['do']) {
	$dle_module = "main";
}]]></searchcode>
			<replacecode><![CDATA[$collections_info = get_vars ( "collections" );

if (!is_array ( $collections_info )) {
	$collections_info = array ();

	$db->query ( "SELECT id, user_name, name, alt_url, descr, num_elem, news_read, news_comm, news_vote, news_rating, date, create_date, cover, news_ids, current_tags, current_xfields, xfields_s, tags_s FROM " . PREFIX . "_news_collections ORDER BY id ASC" );
	while ( $row = $db->get_row () ) {

		$collections_info[$row['id']] = array ();

		foreach ( $row as $key => $value ) {
			$collections_info[$row['id']][$key] = stripslashes ( $value );
		}

	}
	set_vars ( "collections", $collections_info );
	$db->free ();
}]]></replacecode>
		</operation>
	</file>
	<file name="engine/ajax/collections_favorites.php">
		<operation action="create">
			<replacecode><![CDATA[<?php
if(!defined('DATALIFEENGINE')) {
	header( "HTTP/1.1 403 Forbidden" );
	header ( 'Location: ../../' );
	die( "Hacking attempt!" );
}

if( !$is_logged ) die( "error" );

$id = intval( $_REQUEST['fav_id'] );

if( !$id OR $id < 1) die( "error" );

if( $_REQUEST['user_hash'] == "" OR $_REQUEST['user_hash'] != $dle_login_hash ) {

	die ("error");
	
}
	
if( $_REQUEST['action'] == "plus" ) {
	$error = "";
	
	$list = explode( ",", $member_id['favorites_collections'] );
	
	foreach ( $list as $daten ) {

		if( $daten == $id ) $error = "stop";

	}
	
	if( $error != "stop" ) {

		$list[] = $id;
		$favorites = $db->safesql(implode( ",", $list ));
		
		
		if( $member_id['favorites_collections'] == "" ) $favorites = $id;

		
		$member_id['favorites'] = $favorites;
		
		$db->query( "UPDATE " . USERPREFIX . "_users SET favorites_collections='{$favorites}' WHERE user_id = '{$member_id['user_id']}'" );
	
	}

	if ( $_REQUEST['alert'] ) $buffer = $lang['fav_plus'];
	else {
	$buffer = "<img src=\"" . $config['http_home_url'] . "templates/{$config['skin']}/dleimages/minus_fav.gif\" onclick=\"doFavorites_collections('" . $id . "', 'minus'); return false;\" title=\"" . $lang['news_minfav'] . "\" style=\"vertical-align: middle;border: none;\" />";
	}

} elseif( $_REQUEST['action'] == "minus" ) {
	
	$list = explode( ",", $member_id['favorites_collections'] );

	$i = 0;
	
	foreach ( $list as $daten ) {

		if( $daten == $id ) unset( $list[$i] );
		$i ++;

	}
	
	if( count( $list ) ) $favorites = $db->safesql(implode( ",", $list ));
	else $favorites = "";

	$db->query( "UPDATE " . USERPREFIX . "_users SET favorites_collections='{$favorites}' WHERE user_id = '{$member_id['user_id']}'" );

	if ( $_REQUEST['alert'] ) $buffer = $lang['fav_minus'];
	else {
		$buffer = "<img src=\"" . $config['http_home_url'] . "templates/{$config['skin']}/dleimages/plus_fav.gif\" onclick=\"doFavorites_collections('" . $id . "', 'plus'); return false;\" title=\"" . $lang['news_addfav'] . "\" style=\"vertical-align: middle;border: none;\" />";
	}

} else die( "error" );

$db->close();

echo $buffer;
?>]]></replacecode>
		</operation>
	</file>
	<file name="engine/editor/shortnews.php">
		<operation action="after">
			<searchcode><![CDATA[} else $implugin = 'insertImage';]]></searchcode>
			<replacecode><![CDATA[if ($mod == "collections") {
	$image_upload = ""; $image_q_upload = "";
}]]></replacecode>
		</operation>
	</file>
	<file name="engine/modules/addnews.php">
		<operation action="before">
			<searchcode><![CDATA[if( !is_array($_POST['catlist']) ) $_POST['catlist'] = array ();]]></searchcode>
			<replacecode><![CDATA[if( !is_array($_POST['collections_list']) ) $_POST['collections_list'] = array ();
		
if( !count( $_POST['collections_list'] ) ) {
			
	$c_list = array ();
	$c_list[] = '0';
			
} else $c_list = $_POST['collections_list'];

$collections_list = array();
	
foreach ( $c_list as $value ) {
	$collections_list[] = intval($value);
}

$c_list = $collections_list;
$collections_list = $db->safesql( implode( ',', $collections_list ) );

$c_allow = $user_group[$member_id['user_group']]['collections_allow_edit'];

if( count($c_list) AND $c_list[0] != 0 ) {

	if( !$c_allow AND $member_id['user_group'] != "1" ) {
		$stop .= "<li>Вы не можете указывать новостям подборки.</li>";
	}

}]]></replacecode>
		</operation>
		<operation action="replace">
			<searchcode><![CDATA[category, alt_name,]]></searchcode>
			<replacecode><![CDATA[category, collections, alt_name,]]></replacecode>
		</operation>
		<operation action="replace">
			<searchcode><![CDATA['$category_list', '$alt_name',]]></searchcode>
			<replacecode><![CDATA['$category_list', '$collections_list', '$alt_name',]]></replacecode>
		</operation>
		<operation action="before">
			<searchcode><![CDATA[clear_cache( array('news_', 'related_', 'tagscloud_', 'archives_', 'calendar_', 'topnews_', 'rss', 'stats') );]]></searchcode>
			<replacecode><![CDATA[if( count($c_list) AND $c_list[0] != 0 ) {
  
  foreach( $c_list as $val ) {
    
    if( $val ) {
    
      $getCollection = $db->super_query("SELECT news_ids FROM ".PREFIX."_news_collections WHERE id = '{$val}'");	

      if( $getCollection['news_ids'] ) {
        
          $tmp_c = explode(',', $getCollection['news_ids']);
          $tmp_c[] = $news_id;
          $c_list = implode(',', $tmp_c);
        
      } else $c_list = $news_id;

      @unlink( ENGINE_DIR . '/cache/system/collections.php' );
      @unlink( ENGINE_DIR . '/cache/system/collections_title/collections_title_'.$val.'.php' );
      clear_cache( array('collections_news_', 'cblock_list_', 'collection_block_') );
      $db->query("UPDATE ".PREFIX."_news_collections SET date = '{$thistime}', num_elem = num_elem+1, news_ids = '{$c_list}' WHERE id = '{$val}'");
  	  
      collectionsSumNewsRead($val, $c_list);
      
    }
    
  }
  
}]]></replacecode>
		</operation>
		<operation action="before">
			<searchcode><![CDATA[$cat_list = explode( ',', $row['category'] );]]></searchcode>
			<replacecode><![CDATA[$c_list = explode( ',', $row['collections'] );
foreach( $collections_info as $val ) {
   	if( in_array($val['id'], $c_list ) ) $c_opt .= '<option value="'.$val['id'].'" selected>'.$val['name'].'</option>';
 	else $c_opt .= '<option value="'.$val['id'].'">'.$val['name'].'</option>';
}]]></replacecode>
		</operation>
		<operation action="before">
			<searchcode><![CDATA[$tpl->set( '{title}', '' );]]></searchcode>
			<replacecode><![CDATA[foreach( $collections_info as $val ) {
 	$c_opt .= '<option value="'.$val['id'].'">'.$val['name'].'</option>';
}]]></replacecode>
		</operation>
		<operation action="before">
			<searchcode><![CDATA[$tpl->set( '{bbcode}', $bb_code );]]></searchcode>
			<replacecode><![CDATA[$collections_list = "<select data-placeholder=\"Выберите подборки\" name=\"collections_list[]\" id=\"collections\"  style=\"width:350px;\" multiple=\"multiple\">";
$collections_list .= $c_opt;
$collections_list .= "</select>";
$c_allow = $user_group[$member_id['user_group']]['collections_allow_edit'];

if( !$c_allow AND $member_id['user_group'] != "1" ) {
	$tpl->set_block( "'\\[owner-c\\].*?\\[/owner-c\\]'si", '' );
} else {
    if( count($collections_info) ) $tpl->set( '{collections}', $collections_list );
    else $tpl->set( '{collections}', 'Подборок не создано' );
	$tpl->set( '[owner-c]', '' );
	$tpl->set( '[/owner-c]', '' );  
}]]></replacecode>
		</operation>
		<operation action="after">
			<searchcode><![CDATA[$onload_scripts[] = <<<HTML]]></searchcode>
			<replacecode><![CDATA[$('#collections').chosen({allow_single_deselect:true, no_results_text: 'Ничего не найдено'});]]></replacecode>
		</operation>
		<operation action="after">
			<searchcode><![CDATA[$row['id'] = $db->insert_id();]]></searchcode>
			<replacecode><![CDATA[$news_id = $row['id'];]]></replacecode>
		</operation>
	</file>
	<file name="engine/inc/editnews.php">
		<operation action="after">
			<searchcode><![CDATA[include_once (DLEPlugins::Check(ENGINE_DIR . '/classes/parse.class.php'));]]></searchcode>
			<replacecode><![CDATA[$collections_info = get_vars ( "collections" );

if( !is_array ( $collections_info ) ) {
  
	$collections_info = array ();

	$db->query ( "SELECT id, user_name, name, alt_url, descr, num_elem, news_read, news_comm, news_vote, news_rating, date, create_date, cover, news_ids, current_tags, current_xfields, xfields_s, tags_s FROM " . PREFIX . "_news_collections ORDER BY id ASC" );
	
  	while( $row = $db->get_row () ) {

		$collections_info[$row['id']] = array ();

		foreach ( $row as $key => $value ) {
          
			$collections_info[$row['id']][$key] = stripslashes ( $value );
          
		}

	}
  
	set_vars ( "collections", $collections_info );
	$db->free ();
}]]></replacecode>
		</operation>
		<operation action="after">
			<searchcode><![CDATA[$cat_list = explode( ',', $row['category'] );]]></searchcode>
			<replacecode><![CDATA[$c_list = explode( ',', $row['collections'] );
foreach( $collections_info as $val ) {
  
   	if( in_array($val['id'], $c_list ) ) $c_opt .= '<option value="'.$val['id'].'" selected>'.$val['name'].'</option>'; 
 	else $c_opt .= '<option value="'.$val['id'].'">'.$val['name'].'</option>';
  
}]]></replacecode>
		</operation>
		<operation action="after">
			<searchcode><![CDATA[<div class="form-group">
  <label class="control-label col-sm-2">{$lang['edit_cat']}</label>
  <div class="col-sm-10">
	<select data-placeholder="{$lang['addnews_cat_sel']}" name="category[]" id="category" onchange="onCategoryChange(this)" {$category_multiple} style="width:100%;max-width:350px;">{$categories_list}</select>
  </div>
 </div>]]></searchcode>
			<replacecode><![CDATA[<div class="form-group">
  <label class="control-label col-sm-2">Подборки:</label>
  <div class="col-sm-10">
	<select data-placeholder="Выберите подборки..." name="collections_list[]" id="collections" style="width:100%;max-width:350px;" class="categoryselect" multiple>{$c_opt}</select>
  </div>
 </div>]]></replacecode>
		</operation>
		<operation action="before">
			<searchcode><![CDATA[if( !is_array($category) ) $category = array ();]]></searchcode>
			<replacecode><![CDATA[$collections = $_POST['collections_list'];
if( !is_array($collections) ) $collections = array ();
if( !count($collections) ) $collections[] = '0';

$c_list = array();

foreach( $collections as $value ) {
  
	$c_list[] = intval($value);
  
}

$c_allow = explode( ',', $user_group[$member_id['user_group']]['collections_allow_edit'] );

if( count($c_list) AND $c_list[0] != 0 ) {
  
	if( !$c_allow AND $member_id['user_group'] != "1" ) msg( "error", $lang['addnews_error'], "Вы не можете указывать новостям подборки.", "javascript:history.go(-1)" );

}

$c_list = $db->safesql( implode( ',', $c_list ) );]]></replacecode>
		</operation>
		<operation action="replace">
			<searchcode><![CDATA[category='{$category_list}',]]></searchcode>
			<replacecode><![CDATA[category='$category_list', collections='$c_list',]]></replacecode>
		</operation>
		<operation action="before">
			<searchcode><![CDATA[category, approve,]]></searchcode>
			<replacecode><![CDATA[category, collections, approve,]]></replacecode>
		</operation>
		<operation action="after">
			<searchcode><![CDATA[$item_db[8] = $row['category'];]]></searchcode>
			<replacecode><![CDATA[$item_db[9] = $row['collections'];]]></replacecode>
		</operation>
		<operation action="before">
			<searchcode><![CDATA[if( $add_vote ) {]]></searchcode>
			<replacecode><![CDATA[if( $c_list ) {
  
	$c_list = explode( ',', $c_list );
	$tmp_c = explode( ',', $item_db[9] );
	$addC_tmp = array_diff ($c_list, $tmp_c);
	$removeC_tmp = array_diff ($tmp_c, $c_list);  
	$thistime = date( "Y-m-d H:i:s", time() );
  
	if( count($addC_tmp) ) {

		foreach( $addC_tmp as $val ) {
		  
			if( $val ) {
				
				$getCollection = $db->super_query("SELECT news_ids FROM ".PREFIX."_news_collections WHERE id = '{$val}'");	

				if( $getCollection['news_ids'] ) {
					  
				$tmp_c = explode(',', $getCollection['news_ids']);
				$tmp_c[] = $item_db[0];
				$c_list = implode(',', $tmp_c);
					  
				} else $c_list = $item_db[0];

				@unlink( ENGINE_DIR . '/cache/system/collections.php' );
				@unlink( ENGINE_DIR . '/cache/system/collections_title/collections_title_'.$val.'.php' );
				clear_cache( array('collections_news_', 'cblock_list_', 'collection_block_') );
				$db->query("UPDATE ".PREFIX."_news_collections SET date = '{$thistime}', num_elem = num_elem+1, news_ids = '{$c_list}' WHERE id = '{$val}'");
			  
			}
		  
		}

	}

	if( count($removeC_tmp) ) {

		foreach( $removeC_tmp as $val ) {

			if( $val ) {
			  
				$getCollection = $db->super_query("SELECT news_ids FROM ".PREFIX."_news_collections WHERE id = '{$val}'");	

				$list = explode(',', $getCollection['news_ids']);
				$i = 0;

				foreach ( $list as $id ) {

					if( $id == $item_db[0] ) unset( $list[$i] );
					$i ++;

				}

				if( count( $list ) ) $c_list = $db->safesql(implode( ",", $list ));
				else $c_list = "";

				@unlink( ENGINE_DIR . '/cache/system/collections_title/collections_title_'.$val.'.php' );
              	clear_cache( array('collections_news_', 'cblock_list_', 'collection_block_') );
				$db->query("UPDATE ".PREFIX."_news_collections SET num_elem = num_elem - 1, news_ids = '{$c_list}' WHERE id = '{$val}'");
			  
			}
		  
		}

	}
  
} else {
  
  if( $item_db[9] ) {
    
    $tmp_c = explode( ',', $item_db[9] );

    foreach( $tmp_c as $val ) {

        $getCollection = $db->super_query("SELECT news_ids FROM ".PREFIX."_news_collections WHERE id = '{$val}'");
      
   		$list = explode(',', $getCollection['news_ids']);
        $i = 0;

        foreach ( $list as $id ) {

            if( $id == $item_db[0] ) unset( $list[$i] );
            $i ++;

        }

        if( count( $list ) ) $c_list = $db->safesql(implode( ",", $list ));
        else $c_list = "";

        @unlink( ENGINE_DIR . '/cache/system/collections_title/collections_title_'.$val.'.php' );
      	clear_cache( array('collections_news_', 'cblock_list_', 'collection_block_') );
        $db->query("UPDATE ".PREFIX."_news_collections SET num_elem = num_elem - 1, news_ids = '{$c_list}' WHERE id = '{$val}'");

    }    
    
    collectionsSumExtended_info();
  }
  
}]]></replacecode>
		</operation>
	</file>
	<file name="engine/ajax/collections_menu.php">
		<operation action="create">
			<replacecode><![CDATA[<?php
if(!defined('DATALIFEENGINE')) {
	header( "HTTP/1.1 403 Forbidden" );
	header ( 'Location: ../../' );
	die( "Hacking attempt!" );
}

require_once (DLEPlugins::Check(ENGINE_DIR . '/classes/templates.class.php'));

$tpl = new dle_template( );
$tpl->dir = ROOT_DIR . '/templates/' . $config['skin'];
define( 'TEMPLATE_DIR', $tpl->dir );

if( !$is_logged ) die( "error" );

$news_id = intval( $_REQUEST['news_id'] );

if( !$news_id OR $news_id < 1) die( "error" );

if( $_REQUEST['user_hash'] == "" OR $_REQUEST['user_hash'] != $dle_login_hash ) {

	die ("error");
	
}

$c_allow = explode( ',', $user_group[$member_id['user_group']]['collections_allow_edit'] );
if( !$c_allow ) die ("access denied");

$collections_info = get_vars ( "collections" );

if (!is_array ( $collections_info )) {
	$collections_info = array ();

	$db->query ( "SELECT id, user_name, name, alt_url, descr, num_elem, news_read, news_comm, news_vote, news_rating, date, create_date, cover, news_ids, current_tags, current_xfields, xfields_s, tags_s FROM " . PREFIX . "_news_collections ORDER BY id ASC" );
	while ( $row = $db->get_row () ) {

		$collections_info[$row['id']] = array ();

		foreach ( $row as $key => $value ) {
			$collections_info[$row['id']][$key] = stripslashes ( $value );
		}

	}
	set_vars ( "collections", $collections_info );
	$db->free ();
}
	
if( $_REQUEST['action'] == "save" ) {

  	$sql = $db->super_query( "SELECT collections FROM " . PREFIX . "_post WHERE id = '{$news_id}'" );
	$c_list = $c_list_post = $_POST['collections'];
	if( $c_list ) {
	  
	  $c_list = explode( ',', $c_list );
	  $tmp_c = explode( ',', $sql['collections'] );
	  $addC_tmp = array_diff ($c_list, $tmp_c);
	  $removeC_tmp = array_diff ($tmp_c, $c_list);  
	  $thistime = date( "Y-m-d H:i:s", time() );
	  
	  if( count($addC_tmp) ) {

		foreach( $addC_tmp as $val ) {
			
			if( $val ) {	
			  
				$getCollection = $db->super_query("SELECT news_ids FROM ".PREFIX."_news_collections WHERE id = '{$val}'");	

				if( $getCollection['news_ids'] ) {
				  
					$tmp_c = explode(',', $getCollection['news_ids']);
					$tmp_c[] = $news_id;
					$c_list = implode(',', $tmp_c);
				  
				} else $c_list = $news_id;

				@unlink( ENGINE_DIR . '/cache/system/collections.php' );
				@unlink( ENGINE_DIR . '/cache/system/collections_title/collections_title_'.$val.'.php' );
				clear_cache( array('collections_news_', 'cblock_list_', 'collection_block_') );
				$db->query("UPDATE ".PREFIX."_news_collections SET date = '{$thistime}', num_elem = num_elem+1, news_ids = '{$c_list}' WHERE id = '{$val}'");
				
			}
		
		}

	  }

	  if( count($removeC_tmp) ) {

		foreach( $removeC_tmp as $val ) {

			if( $val ) {
				
			  $getCollection = $db->super_query("SELECT news_ids FROM ".PREFIX."_news_collections WHERE id = '{$val}'");	

			  $list = explode(',', $getCollection['news_ids']);
			  $i = 0;

			  foreach ( $list as $id ) {

				if( $id == $news_id ) unset( $list[$i] );
				$i ++;

			  }

			  if( count( $list ) ) $c_list = $db->safesql(implode( ",", $list ));
			  else $c_list = "";

			  @unlink( ENGINE_DIR . '/cache/system/collections_title/collections_title_'.$val.'.php' );
              clear_cache( array('collections_news_', 'cblock_list_', 'collection_block_') );
			  $db->query("UPDATE ".PREFIX."_news_collections SET num_elem = num_elem - 1, news_ids = '{$c_list}' WHERE id = '{$val}'");
			  
			}
		  
		}

	  }
	  
	} else {
	  
	  if( $sql['collections'] ) {
		
		$tmp_c = explode( ',', $sql['collections'] );

		foreach( $tmp_c as $val ) {

			$getCollection = $db->super_query("SELECT news_ids FROM ".PREFIX."_news_collections WHERE id = '{$val}'");
		  
			$list = explode(',', $getCollection['news_ids']);
			$i = 0;

			foreach ( $list as $id ) {

				if( $id == $news_id ) unset( $list[$i] );
				$i ++;

			}

			if( count( $list ) ) $c_list = $db->safesql(implode( ",", $list ));
			else $c_list = "";

			@unlink( ENGINE_DIR . '/cache/system/collections_title/collections_title_'.$val.'.php' );
          	clear_cache( array('collections_news_', 'cblock_list_', 'collection_block_') );
			$db->query("UPDATE ".PREFIX."_news_collections SET num_elem = num_elem - 1, news_ids = '{$c_list}' WHERE id = '{$val}'");

		}    
		
	  }
	  
	}

  	collectionsSumExtended_info();
  
	$db->query("UPDATE ".PREFIX."_post SET collections = '{$c_list_post}' WHERE id = '{$news_id}'");

	$buffer = "ok";


} else {
  
  	$sql = $db->super_query( "SELECT collections FROM " . PREFIX . "_post WHERE id = '{$news_id}'" );
  
  	$tpl->load_template( 'collections_editnews.tpl' );
  
    $c_list = explode( ',', $sql['collections'] );
    foreach( $collections_info as $val ) {
		
        if( in_array($val['id'], $c_list ) ) $c_opt .= '<option value="'.$val['id'].'" selected>'.$val['name'].'</option>';
        else $c_opt .= '<option value="'.$val['id'].'">'.$val['name'].'</option>';
		
    }
      
    $collections_list = "<select data-placeholder=\"Выберите подборки\" name=\"collections_list[]\" id=\"collections\"  multiple=\"multiple\">";
    $collections_list .= $c_opt;
    $collections_list .= "</select>";
	
    $tpl->set( '{collections}', $collections_list );  
    $tpl->set( '{id}', $news_id );  
  
	$tpl->compile( 'result' );
	$tpl->clear();
  	$tpl->result['result'] = str_replace( '{THEME}', $config['http_home_url'] . 'templates/' . $config['skin'], $tpl->result['result'] );
  	$buffer = $tpl->result['result'];
}

echo $buffer;
?>]]></replacecode>
		</operation>
	</file>
	<file name="engine/modules/main.php">
		<operation action="before">
			<searchcode><![CDATA[$tpl->copy_template = str_replace ( "{topnews}", $tpl->result['topnews'], $tpl->copy_template );]]></searchcode>
			<replacecode><![CDATA[if( $collections_id ) {

  	$collections['name'] = stripslashes( $collections['name'] );
	$tpl->set( '{c-title}', str_replace("&amp;amp;", "&amp;",  htmlspecialchars( $collections['name'], ENT_QUOTES, $config['charset'] ) ) );
	if( $collections['metadescr'] ) $tpl->set( '{c-meta-descr}', $collections['metadescr'] );
    else $tpl->set( '{c-meta-descr}', "" );
  	if( $collections['descr'] ) {
      
      	$collections['descr'] = stripslashes($collections['descr']);
      	$tpl->set( '{c-descr}', $collections['descr'] );
      
		if ( preg_match( "#\\{c-descr limit=['\"](.+?)['\"]\\}#i", $tpl->copy_template, $matches ) ) {
				
			$count= intval($matches[1]);
			$collections['descr'] = preg_replace ( "#\[hide(.*?)\](.+?)\[/hide\]#is", "", $collections['descr'] );
			$collections['descr'] = preg_replace( "#<!--dle_spoiler(.+?)<!--spoiler_text-->#is", "", $collections['descr'] );
			$collections['descr'] = preg_replace( "#<!--spoiler_text_end-->(.+?)<!--/dle_spoiler-->#is", "", $collections['descr'] );
			$collections['descr'] = str_replace( "><", "> <", $collections['descr'] );
			$collections['descr'] = strip_tags( $collections['descr'], "<br>" );
			$collections['descr'] = trim(str_replace( "<br>", " ", str_replace( "<br />", " ", str_replace( "\n", " ", str_replace( "\r", "", $collections['descr'] ) ) ) ));
			$collections['descr'] = preg_replace('/\s+/u', ' ', $collections['descr']);

			if( $count AND dle_strlen( $row['descr'], $config['charset'] ) > $count ) {
										
				$row['descr'] = dle_substr( $row['descr'], 0, $count, $config['charset'] );
											
				if( ($temp_dmax = dle_strrpos( $row['descr'], ' ', $config['charset'] )) ) $row['descr'] = dle_substr( $row['descr'], 0, $temp_dmax, $config['charset'] );
									
			}
					
			$tpl->set( $matches[0], $row['descr'] );
				
		}       
      
    } else $tpl->set( '{c-descr}', '' );
  
    $tpl->set( '[collections-show]', '' );
    $tpl->set( '[/collections-show]', '' );
    $tpl->set_block( "'\\[collections-alllist\\](.*?)\\[/collections-alllist\\]'si", "" );
  
  	if( $config['collections_often_collections'] AND $ids_r ) {
      
        $tpl->set( '[collections-often]', '' );
        $tpl->set( '[/collections-often]', '' );
      
		if( $often_t ) $tpl->set( '{collections-often}', $often_t );
		else $tpl->set( '{collections-often}', 'Частых подборок нету' );
      
    } else {
      
      	$tpl->set_block( "'\\[collections-often\\](.*?)\\[/collections-often\\]'si", "" );
    	$tpl->set( '{collections-often}', '' );
      
    }
  
} else {
  
  	$tpl->set_block( "'\\[collections-often\\](.*?)\\[/collections-often\\]'si", "" );
    $tpl->set_block( "'\\[collections-show\\](.*?)\\[/collections-show\\]'si", "" );
  
  	if( $do == 'collections' ) {
      
      $tpl->set( '[collections-alllist]', '' );
      $tpl->set( '[/collections-alllist]', '' );
      $tpl->set( '{c-title}', $config['collection_title'] );
      $tpl->set( '{c-descr}', $config['collection_description'] );      
      
    } else {
      
      $tpl->set_block( "'\\[collections-alllist\\](.*?)\\[/collections-alllist\\]'si", "" );
      $tpl->set( '{c-title}', '' );
      $tpl->set( '{c-descr}', '' );
      
    }
  
	$tpl->set( '{c-meta-descr}', "" );
  
}]]></replacecode>
		</operation>
		<operation action="after">
			<searchcode><![CDATA[$tpl->compile ( 'main' );]]></searchcode>
			<replacecode><![CDATA[if (stripos ( $tpl->result['main'], "{collections-custom" ) !== false) {
	$tpl->result['main'] = preg_replace_callback ( "#\\{collections-custom(.+?)?\\}#i", "show_collections", $tpl->result['main'] );
}]]></replacecode>
		</operation>
		<operation action="before">
			<searchcode><![CDATA[if (stripos ( $tpl->copy_template, "{custom" ) !== false) {
	$tpl->copy_template = preg_replace_callback ( "#\\{custom(.+?)\\}#i", "custom_print", $tpl->copy_template );
}]]></searchcode>
			<replacecode><![CDATA[if (stripos ( $tpl->copy_template, "{collections ids-news" ) !== false) {
	$tpl->copy_template = preg_replace_callback ( "#\\{collections ids-news(.+?)\\}#i", "show_news_collections", $tpl->copy_template );
}]]></replacecode>
		</operation>
	</file>
	<file name="engine/modules/functions.php">
		<operation action="before">
			<searchcode><![CDATA[function custom_print( $matches=array() ) {]]></searchcode>
			<replacecode><![CDATA[function search_collections( $t = false ) {
	global $collections_info, $collections_link, $collections_list, $collections_text, $tpl, $config, $row;
  
  	if( !$t ) {
      
      $collections_text = array ();
      $collections_link = array ();	
      $collections_list = array();
      
    } else $collections_list = count($collections_list) > 0 ? $collections_list : array();
  
  	foreach( $collections_info as $val) {
      
		/*if( $val['current_tags'] ) {
			
			$s_t = explode(', ', $val['current_tags']);
			if( preg_match("/" . implode('|', $s_t) . "/i", implode(', ', $row['tags'])) ) $collections_list[] = $val['id'];

		}
      
      	if( $val['current_xfields'] ) {
			
			$s_t = explode(', ', $val['current_xfields']);
			
			if( preg_match("/" . addslashes( implode('|', $s_t) ) . "/i", $row['xfields']) ) $collections_list[] = $val['id'];
			
		}*/
		
		if( $val['current_tags'] OR $val['current_xfields'] ) {
			
			$s_t = explode(', ', $val['current_tags']);
			$s_t2 = explode(', ', $val['current_xfields']);
			if( preg_match("/" . implode('|', $s_t) . "/i", implode(', ', $row['tags'])) AND preg_match("/" . addslashes( implode('|', $s_t2) ) . "/i", $row['xfields']) ) $collections_list[] = $val['id'];

		}
      
    }  
  
  	if( count($collections_list) ) {
  
		$config['collection_separator'] = $config['collection_separator'] ? $config['collection_separator'] : ',';
		  
		if( count( $collections_list ) == 1 ) {
					
			$collections_text[] = $collections_info[$collections_list[0]]['name'];
		  
			if( $config['allow_alt_url'] ) {
			  
				$collections_link[] = "<a href=\"" . $config['http_home_url'] . "collections/{$collections_info[$collections_list[0]]['id']}-{$collections_info[$collections_list[0]]['alt_url']}" . "\">{$collections_info[$collections_list[0]]['name']}</a>";
			
			} else {
			  
				$collections_link[] = "<a href=\"$PHP_SELF?do=collections&amp;id={$collections_info[$collections_list[0]]['id']}\">{$collections_info[$collections_list[0]]['name']}</a>";
			
			}
		  
		} else {
					
			foreach ( $collections_list as $element ) {
						
				if( $element ) {
					$collections_text[] = $collections_info[$element]['name'];
				  
					if( $config['allow_alt_url'] ) {	
						$collections_link[] = "<a href=\"" . $config['http_home_url'] . "collections/{$collections_info[$element]['id']}-{$collections_info[$element]['alt_url']}" . "\">{$collections_info[$element]['name']}</a>";
					} else {	
						$collections_link[] = "<a href=\"$PHP_SELF?do=collections&amp;id={$collections_info[$element]['id']}\">{$collections_info[$element]['name']}</a>";
					}

				}
			  
			}  
	  
		}

		if( !$t ) {
		  
			$collections_link = implode( " {$config['collection_separator']} ", $collections_link );		
			$collections_text = implode( " {$config['collection_separator']} ", $collections_text );

			$tpl->set( '{collections-link}', 'Подборки: ' . $collections_link );
			$tpl->set( '{collections}', 'Подборки: ' . $collections_text );
			$tpl->set( '[not-collections]', "" );
			$tpl->set( '[/not-collections]', "" );
		 
		}

		if (stripos ( $tpl->copy_template, "{collections-custom" ) !== false) {
			$tpl->copy_template = preg_replace_callback ( "#\\{collections-custom(.+?)?\\}#i", "show_collections", $tpl->copy_template );
		}	

	  
    } else {
      
		if( !$t ) {
			
			$tpl->set( '{collections-link}', 'Подборки: Не заданы' );
			$tpl->set( '{collections}', 'Подборки: Не заданы' );
			$tpl->set( '{owner-cnews-list}', '' );
			$tpl->set_block( "'\\[not-collections\\](.*?)\\[/not-collections\\]'si", "" );
			
			if (stripos ( $tpl->copy_template, "{collections-custom" ) !== false) {
				$tpl->copy_template = preg_replace ( "#\\{collections-custom(.+?)?\\}#i", "", $tpl->copy_template );
			}		
			
		}
      
    }
}

function show_collections( $matches=array() ) {
	global $db, $config, $_TIME, $collections_list;
		
	$param_str = trim($matches[1]);
	$custom_cache_id = "show_collections".$param_str.$config['skin'];
	$thisdate = date( "Y-m-d H:i:s", $_TIME );
	$sql_select = "SELECT id, name, alt_url, descr, date, create_date, num_elem, news_read, news_comm, news_vote, news_rating, cover FROM " . PREFIX . "_news_collections";
	$where = array();
	$allow_cache = $config['allow_cache'];

	if( preg_match( "#owner_news=['\"]true['\"]#i", $param_str, $match ) ) {

      	if( !count($collections_list) ) return;
      
		$temp_array = implode(',', $collections_list);

		$custom_category = $db->safesql( trim($temp_array) );
		$custom_category = str_replace( ",", "','", $custom_category );
	
		$where[] = "id IN ('" . $custom_category . "')";
		$owner = true;
      
	} else {
		
		if( preg_match( "#id=['\"](.+?)['\"]#i", $param_str, $match ) ) {

            $temp_array = array();
            $where_id = array();
            $match[1] = explode (',', trim($match[1]));

            foreach ($match[1] as $value) {

                if( count(explode('-', $value)) == 2 ) {
                    $value = explode('-', $value);
                    $where_id[] = "id >= '" . intval($value[0]) . "' AND id <= '".intval($value[1])."'";

                } else $temp_array[] = intval($value);

            }

            if ( count($temp_array) ) {

                $where_id[] = "id IN ('" . implode("','", $temp_array) . "')";

            }

            if ( count($where_id) ) { 
                $custom_id = "(".implode(' OR ', $where_id).")";
                $where[] = $custom_id;

            }          

		} else $where[] = "1";
      
		$owner = false;
      
	}
  
	if( preg_match( "#days=['\"](.+?)['\"]#i", $param_str, $match ) ) {
		
		$days = intval(trim($match[1]));
				
		if( $fromfuture ) {
					
			$startdate = date("Y-m-d 00:00:00", strtotime("+1 day"));
			$enddate = date("Y-m-d 00:00:00", strtotime("+".($days+1)." day"));
			$where[] = "date >= '{$startdate}' AND date < '{$enddate}'";
					
		} else $where[] = "date >= '{$thisdate}' - INTERVAL {$days} DAY AND date < '{$thisdate}'";
			
	} else $days = 0;
		
	if( preg_match( "#template=['\"](.+?)['\"]#i", $param_str, $match ) ) {
		
		$custom_template = trim($match[1]);
		
	} else $custom_template = "collections_block";

	if( preg_match( "#sort=['\"](.+?)['\"]#i", $param_str, $match ) ) {
		
		$allowed_sort = array ('asc' => 'ASC', 'desc' => 'DESC' );

		$match[1] = strtolower($match[1]);

		if ( $allowed_sort[$match[1]] ) $news_msort = $allowed_sort[$match[1]];

	} else $news_msort = 'ASC';

	if( preg_match( "#limit=['\"](.+?)['\"]#i", $param_str, $match ) ) {
	
		$limit = " LIMIT " . intval($match[1]);
	
	} else {
		
		if( !$owner ) $limit = " LIMIT 1";
		
	}  
	  
	if( preg_match( "#order=['\"](.+?)['\"]#i", $param_str, $match ) ) {
	
		$allowed_sort = array ('date' => 'date', 'create_date' => 'create_date', 'num_elem' => 'num_elem', 'news_read' => 'news_read', 'news_rating' => 'news_rating', 'news_vote' => 'news_vote', 'news_comm' => 'news_comm', 'name' => 'name', 'rand' => 'RAND()' );
		$extended = array('news_read','news_rating','news_vote','news_comm');
      
		$match[1] = strtolower($match[1]);

		if ( $allowed_sort[$match[1]] ) $news_sort = $allowed_sort[$match[1]];

		if ( $match[1] == "rand" ) { $news_msort = ""; }
      	if ( !$config['collections_extended_info'] AND in_array($match[1], $extended) ) { $news_sort = "date"; }

	} else $news_sort = "date";

	$content = dle_cache( "collection_block", $custom_cache_id, true );
		
	if( $content !== false ) {
			
		$config['allow_cache'] = $allow_cache;
					
		return $content;
		
	} else {

		$tpl = new dle_template();
		$tpl->dir = TEMPLATE_DIR;				

		$tpl->load_template( $custom_template . '.tpl' );
		$sql_select .= " WHERE ".implode(' AND ', $where)." ORDER BY " . $news_sort . " " . $news_msort . $limit;
				
		$sql_result = $db->query( $sql_select );

		while ( $row = $db->get_row( $sql_result ) ) {
				  
			$found = true;
					  
			$row['date'] = strtotime( $row['date'] );
			$row['name'] = stripslashes( $row['name'] );
			$row['descr'] = stripslashes($row['descr']);
			$tpl->set( '{descr}', $row['descr'] );

			if ( preg_match( "#\\{descr limit=['\"](.+?)['\"]\\}#i", $tpl->copy_template, $matches ) ) {
				
				$count= intval($matches[1]);
				$row['descr'] = preg_replace ( "#\[hide(.*?)\](.+?)\[/hide\]#is", "", $row['descr'] );
				$row['descr'] = preg_replace( "#<!--dle_spoiler(.+?)<!--spoiler_text-->#is", "", $row['descr'] );
				$row['descr'] = preg_replace( "#<!--spoiler_text_end-->(.+?)<!--/dle_spoiler-->#is", "", $row['descr'] );
				$row['descr'] = str_replace( "><", "> <", $row['descr'] );
				$row['descr'] = strip_tags( $row['descr'], "<br>" );
				$row['descr'] = trim(str_replace( "<br>", " ", str_replace( "<br />", " ", str_replace( "\n", " ", str_replace( "\r", "", $row['descr'] ) ) ) ));
				$row['descr'] = preg_replace('/\s+/u', ' ', $row['descr']);

				if( $count AND dle_strlen( $row['descr'], $config['charset'] ) > $count ) {
										
					$row['descr'] = dle_substr( $row['descr'], 0, $count, $config['charset'] );
											
					if( ($temp_dmax = dle_strrpos( $row['descr'], ' ', $config['charset'] )) ) $row['descr'] = dle_substr( $row['descr'], 0, $temp_dmax, $config['charset'] );
									
				}
					
				$tpl->set( $matches[0], $row['descr'] );
				
			}          
					  
			$tpl->set( '{title}', str_replace("&amp;amp;", "&amp;",  htmlspecialchars( $row['name'], ENT_QUOTES, $config['charset'] ) ) );

			if ( preg_match( "#\\{title limit=['\"](.+?)['\"]\\}#i", $tpl->copy_template, $matches ) ) {
				
				$count= intval($matches[1]);
				$row['name'] = strip_tags( $row['name'] );

				if( $count AND dle_strlen( $row['name'], $config['charset'] ) > $count ) {
							
					$row['name'] = dle_substr( $row['name'], 0, $count, $config['charset'] );
											
					if( ($temp_dmax = dle_strrpos( $row['name'], ' ', $config['charset'] )) ) $row['name'] = dle_substr( $row['name'], 0, $temp_dmax, $config['charset'] );
									
				}

				$tpl->set( $matches[0], str_replace("&amp;amp;", "&amp;",  htmlspecialchars( $row['name'], ENT_QUOTES, $config['charset'] ) ) );

			}
					  
			if( date( 'Ymd', $row['date'] ) == date( 'Ymd', $_TIME ) ) {

				$tpl->set( '{date}', $lang['time_heute'] . langdate( ", H:i", $row['date'] ) );

			} elseif( date( 'Ymd', $row['date'] ) == date( 'Ymd', ($_TIME - 86400) ) ) {

				$tpl->set( '{date}', $lang['time_gestern'] . langdate( ", H:i", $row['date'] ) );

			} else {

				$tpl->set( '{date}', langdate( $config['timestamp_active'], $row['date'] ) );

			}
					  
			if( $row['cover'] AND file_exists( ROOT_DIR . '/uploads/posts/' . $row['cover'] ) ) {

				$tpl->set( '{cover}', $config['http_home_url'] . 'uploads/posts/' . $row['cover'] );

			} else $tpl->set( '{cover}', '{THEME}/dleimages/no_image.jpg'  );
				
			if( $config['allow_alt_url'] ) $url = $config['http_home_url'] . 'collections/' . $row['id'] . '-' . $row['alt_url'];
			else $url = $config['http_home_url'] . '?do=collections&id=' . $row['id'];

            $tpl->set( '{num_elem}', 	intval($row['num_elem']) );
            $tpl->set( '{news_read}', 	intval($row['news_read']) );
            $tpl->set( '{news_rating}', intval($row['news_rating']) );
            $tpl->set( '{news_vote}', 	intval($row['news_vote']) );
            $tpl->set( '{news_comm}', 	intval($row['news_comm']) );          
			$tpl->set( '{url}', $url );

			$tpl->compile( 'collections' );	
					  
		} 
				  
		if ( $found ) create_cache( "collection_block", $tpl->result['collections'], $custom_cache_id, true );
					
		$config['allow_cache'] = $allow_cache;
					
		return $tpl->result['collections'];
		
	}

}

function show_news_collections( $matches=array() ) {
	global $collections_info;
		
	$param_str = trim($matches[1]);

	if( preg_match( "#id=['\"]?(.+?)['\"]?#i", $param_str, $match ) ) {
		
		$id = intval(trim($match[1]));

        if( $collections_info[$id]['news_ids'] ) {
			$ids = $collections_info[$id]['news_ids'];
        } else $ids = 0;
      
	} else $ids = 0;

  	return $ids;
}

function collectionsSumExtended_info( $c_id = 0, $news_ids = 0 ) {
  	global $db;	

    if( $c_id ) {

		$collections = $db->super_query("SELECT id, news_ids, current_tags, current_xfields, tags_s, xfields_s FROM `".PREFIX."_news_collections` WHERE id = '{$c_id}'");
	
		$where = array();
		$current_select_tags = " ";
		if( $collections['current_tags'] OR $collections['current_xfields'] ) {
			
			if( $collections['current_tags'] ) {
				
				$collections['current_tags'] = explode(',', $collections['current_tags']);
				$regexp_arr = array();
				$current_select_tags = " INNER JOIN " . PREFIX . "_tags t on (t.news_id=p.id) ";
					
				foreach( $collections['current_tags'] as $val ) {
						
					$val = @$db->safesql( trim($val) );
					$regexp_arr[] = "t.tag regexp '[[:<:]](" . $val . ")[[:>:]]'";
		
				}

				$where['tags'] = "(" . implode(" {$collections['tags_s']} ", $regexp_arr) . ")";
			}
			
			if( $collections['current_xfields'] ) {
				
				$collections['current_xfields'] = explode(',', $collections['current_xfields']);
				$regexp_arr = array();
				
				foreach( $collections['current_xfields'] as $val ) {
					
					$val = @$db->safesql( trim($val) );
					$regexp_arr[] = "p.xfields regexp '[[:<:]](" . $val . ")[[:>:]]'";

				}
				
				$where['xf'] = "(" . implode(" {$collections['xfields_s']} ", $regexp_arr) . ")";
				
			}			
			
		} else {
			
			$collections['news_ids'] = explode(',', $collections['news_ids']);
			$where[] = "p.id regexp '[[:<:]](" . @$db->safesql( implode('|', $collections['news_ids']) ) . ")[[:>:]]'";
			
		}	
		
		if( count($where) ) {
			
			$where = implode(' AND ', $where);
	
			$news_read = $db->super_query("SELECT count(p.id) as num_elem, sum(e.news_read) as sum_read, sum(e.rating) as sum_rating, sum(e.vote_num) as sum_vote, sum(p.comm_num) as sum_comm FROM `".PREFIX."_post` p{$current_select_tags}LEFT JOIN `".PREFIX."_post_extras` e ON (p.id=e.news_id) WHERE {$where}");
			
			$news_read['num_elem'] 		= $news_read['num_elem'] 	? $news_read['num_elem'] 	: 0;
			$news_read['sum_read'] 		= $news_read['sum_read'] 	? $news_read['sum_read'] 	: 0;
			$news_read['sum_rating'] 	= $news_read['sum_rating'] 	? $news_read['sum_rating'] 	: 0;
			$news_read['sum_vote'] 		= $news_read['sum_vote'] 	? $news_read['sum_vote'] 	: 0;
			$news_read['sum_comm'] 		= $news_read['sum_comm'] 	? $news_read['sum_comm'] 	: 0;
			
			$sum_info = array();
			
			$sum_info[] = "num_elem = '{$news_read['num_elem']}'";
			$sum_info[] = "news_read = '{$news_read['sum_read']}'";
			$sum_info[] = "news_rating = '{$news_read['sum_rating']}'";
			$sum_info[] = "news_vote = '{$news_read['sum_vote']}'";
			$sum_info[] = "news_comm = '{$news_read['sum_comm']}'";
			$sum_info 	= implode(', ', $sum_info);

			$db->query( "UPDATE " . PREFIX . "_news_collections SET {$sum_info} WHERE id = '{$c_id}'" );

		}
		
    } else {

      $sql = $db->super_query("SELECT id, news_ids, current_tags, current_xfields, tags_s, xfields_s FROM `".PREFIX."_news_collections`", true);

      foreach( $sql as $collections ) {
		
        if( !$collections['news_ids'] AND (!$collections['current_tags'] AND !$collections['current_xfields']) ) continue;
        
		$where = array();
		$current_select_tags = " ";
		if( $collections['current_tags'] OR $collections['current_xfields'] ) {
			
			if( $collections['current_tags'] ) {
				
				$collections['current_tags'] = explode(',', $collections['current_tags']);
				$regexp_arr = array();
				$current_select_tags = " INNER JOIN " . PREFIX . "_tags t on (t.news_id=p.id) ";
					
				foreach( $collections['current_tags'] as $val ) {
						
					$val = @$db->safesql( trim($val) );
					$regexp_arr[] = "t.tag regexp '[[:<:]](" . $val . ")[[:>:]]'";
		
				}

				$where['tags'] = "(" . implode(" {$collections['tags_s']} ", $regexp_arr) . ")";
			}
			
			if( $collections['current_xfields'] ) {
				
				$collections['current_xfields'] = explode(',', $collections['current_xfields']);
				$regexp_arr = array();
				
				foreach( $collections['current_xfields'] as $val ) {
					
					$val = @$db->safesql( trim($val) );
					$regexp_arr[] = "p.xfields regexp '[[:<:]](" . $val . ")[[:>:]]'";

				}
				
				$where['xf'] = "(" . implode(" {$collections['xfields_s']} ", $regexp_arr) . ")";
				
			}			
			
		} else {
			
			$collections['news_ids'] = explode(',', $collections['news_ids']);
			$where[] = "p.id regexp '[[:<:]](" . @$db->safesql( implode('|', $collections['news_ids']) ) . ")[[:>:]]'";
			
		}	
		
		if( count($where) ) {
			
			$where = implode(' AND ', $where); 
 
			$news_read = $db->super_query("SELECT count(p.id) as num_elem, sum(e.news_read) as sum_read, sum(e.rating) as sum_rating, sum(e.vote_num) as sum_vote, sum(p.comm_num) as sum_comm FROM `".PREFIX."_post` p{$current_select_tags}LEFT JOIN `".PREFIX."_post_extras` e ON (p.id=e.news_id) WHERE {$where}");
		
			$news_read['num_elem'] 		= $news_read['num_elem'] 	? $news_read['num_elem'] 	: 0;
			$news_read['sum_read'] 		= $news_read['sum_read'] 	? $news_read['sum_read'] 	: 0;
			$news_read['sum_rating'] 	= $news_read['sum_rating'] 	? $news_read['sum_rating'] 	: 0;
			$news_read['sum_vote'] 		= $news_read['sum_vote'] 	? $news_read['sum_vote'] 	: 0;
			$news_read['sum_comm'] 		= $news_read['sum_comm'] 	? $news_read['sum_comm'] 	: 0;
			
			$sum_info = array();
			
			$sum_info[] = "num_elem = '{$news_read['num_elem']}'";
			$sum_info[] = "news_read = '{$news_read['sum_read']}'";
			$sum_info[] = "news_rating = '{$news_read['sum_rating']}'";
			$sum_info[] = "news_vote = '{$news_read['sum_vote']}'";
			$sum_info[] = "news_comm = '{$news_read['sum_comm']}'";
			$sum_info 	= implode(', ', $sum_info);
			
			$db->query( "UPDATE " . PREFIX . "_news_collections SET {$sum_info} WHERE id = '{$collections['id']}'" );

		}
		
      }

    }
  
}

function collections_often($ids = 0) {
  global $collections_id, $config;
  
  if( !$ids ) return false;
  
  $often_limit = $config['collections_min_often'] ? $config['collections_min_often'] : 3;
  $t_ids = explode(',', $ids);
  $ids_tmp = array();
  $t_ids = array_count_values($t_ids);

  foreach( $t_ids as $key => $val ) {
    
    if( $key != $collections_id ) {
		
	  if( $val >= $often_limit ) $ids_tmp[] = $key;	  
      
    }
    
  }

  if( count($ids_tmp) ) {
	  
    arsort($ids_tmp);
  	return implode(',', $ids_tmp);
	
  } else return null;
  
}]]></replacecode>
		</operation>
		<operation action="replace">
			<searchcode><![CDATA[p.category, p.alt_name,]]></searchcode>
			<replacecode><![CDATA[p.category, p.collections, p.alt_name,]]></replacecode>
		</operation>
		<operation action="replace">
			<searchcode><![CDATA[$db, $is_logged, $member_id, $xf_inited,]]></searchcode>
			<replacecode><![CDATA[$db, $is_logged, $member_id, $xf_inited, $remove_canonical, $custom_navigation, $news_found, $collections_info, $collections_link, $collections_list, $collections_text, $row,]]></replacecode>
		</operation>
	</file>
	<file name="engine/inc/search.php">
		<operation action="before">
			<searchcode><![CDATA[if (in_array("news", $_POST['table'])) {]]></searchcode>
			<replacecode><![CDATA[if (in_array("collections", $_POST['table'])) {
	$db->query("UPDATE `" . PREFIX . "_news_collections` SET `descr`=REPLACE(`descr`,'$find','$replace')");
}]]></replacecode>
		</operation>
		<operation action="after">
			<searchcode><![CDATA[<option value="banners" selected>{$lang['find_rbanners']}</option>]]></searchcode>
			<replacecode><![CDATA[<option value="collections">Подборки новостей</option>]]></replacecode>
		</operation>
	</file>
	<file name="engine/modules/deletenews.php">
		<operation action="replace">
			<searchcode><![CDATA[category, alt_name]]></searchcode>
			<replacecode><![CDATA[category, collections, alt_name]]></replacecode>
		</operation>
		<operation action="after">
			<searchcode><![CDATA[deletenewsbyid( $row['id'] );]]></searchcode>
			<replacecode><![CDATA[if( $row['collections'] ) {
    
  $tmp_c = explode( ',', $row['collections'] );

  foreach( $tmp_c as $val ) {

    $getCollection = $db->super_query("SELECT news_ids FROM ".PREFIX."_news_collections WHERE id = '{$val}'");

    $list = explode(',', $getCollection['news_ids']);
    $i = 0;

    foreach ( $list as $id ) {

      if( $id == $row['id'] ) unset( $list[$i] );
      $i ++;

    }

    if( count( $list ) ) $c_list = $db->safesql(implode( ",", $list ));
    else $c_list = "";
	
    @unlink( ENGINE_DIR . '/cache/system/collections_title/collections_title_'.$val.'.php' );
    clear_cache( array('collections_news_', 'cblock_list_', 'collection_block_') );
    $db->query("UPDATE ".PREFIX."_news_collections SET num_elem = num_elem - 1, news_ids = '{$c_list}' WHERE id = '{$val}'");

  }
  
  collectionsSumExtended_info();
  
}]]></replacecode>
		</operation>
	</file>
	<file name="engine/inc/usergroup.php">
		<operation action="after">
			<searchcode><![CDATA[$allow_file_upload = intval( $_REQUEST['allow_file_upload'] );]]></searchcode>
			<replacecode><![CDATA[$collections_allow_edit = intval( $_REQUEST['collections_allow_edit'] );]]></replacecode>
		</operation>
		<operation action="replace">
			<searchcode><![CDATA[allow_file_upload,]]></searchcode>
			<replacecode><![CDATA[allow_file_upload, collections_allow_edit,]]></replacecode>
		</operation>
		<operation action="replace">
			<searchcode><![CDATA['$allow_file_upload', '$allow_signature',]]></searchcode>
			<replacecode><![CDATA['$allow_file_upload', 'collections_allow_edit', '$allow_signature',]]></replacecode>
		</operation>
		<operation action="replace">
			<searchcode><![CDATA[allow_file_upload='$allow_file_upload',]]></searchcode>
			<replacecode><![CDATA[allow_file_upload='$allow_file_upload', collections_allow_edit='$collections_allow_edit',]]></replacecode>
		</operation>
		<operation action="after">
			<searchcode><![CDATA[if( $user_group[$id]['allow_file_upload'] ) $allow_file_upload = "checked";]]></searchcode>
			<replacecode><![CDATA[if( $user_group[$id]['collections_allow_edit'] ) $collections_allow_edit = "checked";]]></replacecode>
		</operation>
		<operation action="after">
			<searchcode><![CDATA[<tr>
    <td><h6 class="media-heading text-semibold">{$lang['opt_sys_file']}</h6><span class="text-muted text-size-small hidden-xs">{$lang['opt_sys_filed']}</span></td>
    <td><input class="switch" type="checkbox" name="allow_file_upload" {$allow_file_upload} value="1" {$gastgroup}></td>
</tr>]]></searchcode>
			<replacecode><![CDATA[<tr>
    <td><h6 class="media-heading text-semibold">Разрешение группе редактировать подборки</h6></td>
    <td><input class="switch" type="checkbox" name="collections_allow_edit" {$collections_allow_edit} value="1" {$admingroup}></td>
</tr>]]></replacecode>
		</operation>
	</file>
	<file name="engine/inc/include/functions.inc.php">
		<operation action="replace">
			<searchcode><![CDATA[function set_vars($file, $data) {

	$file = totranslit($file, true, false);

	if ( is_array($data) OR is_int($data) ) {
		
		file_put_contents (ENGINE_DIR . '/cache/system/' . $file . '.php', json_encode( $data, JSON_UNESCAPED_UNICODE | JSON_UNESCAPED_SLASHES ), LOCK_EX);
		@chmod( ENGINE_DIR . '/cache/system/' . $file . '.php', 0666 );

	}

}]]></searchcode>
			<replacecode><![CDATA[function set_vars($file, $data, $path = false) {
	
	$file = totranslit($file, true, false);
	
	if ( is_array($data) OR is_int($data) ) {
		
		if(!$path){
		file_put_contents (ENGINE_DIR . '/cache/system/' . $file . '.php', json_encode( $data, JSON_UNESCAPED_UNICODE | JSON_UNESCAPED_SLASHES ), LOCK_EX);
		@chmod( ENGINE_DIR . '/cache/system/' . $file . '.php', 0666 );
		}else{
		file_put_contents (ENGINE_DIR . $path . $file . '.php', json_encode( $data, JSON_UNESCAPED_UNICODE | JSON_UNESCAPED_SLASHES ), LOCK_EX);
		@chmod( ENGINE_DIR . $path . $file . '.php', 0666 );			
		}
	}
}]]></replacecode>
		</operation>
		<operation action="replace">
			<searchcode><![CDATA[function get_vars($file) {
	$file = totranslit($file, true, false);

	$data = @file_get_contents( ENGINE_DIR . '/cache/system/' . $file . '.php' );

	if ( $data !== false ) {

		$data = json_decode( $data, true );
		if ( is_array($data) OR is_int($data) ) return $data;

	} 

	return false;

}]]></searchcode>
			<replacecode><![CDATA[function get_vars($file, $path = false) {
	$file = totranslit($file, true, false);

	if(!$path) $data = @file_get_contents( ENGINE_DIR . '/cache/system/' . $file . '.php' );
	else $data = @file_get_contents( ENGINE_DIR . $path . $file . '.php' );

	if ( $data !== false ) {

		$data = json_decode( $data, true );
		if ( is_array($data) OR is_int($data) ) return $data;

	} 

	return false;	
}]]></replacecode>
		</operation>
		<operation action="before">
			<searchcode><![CDATA[function dle_session( $sid = false ) {]]></searchcode>
			<replacecode><![CDATA[function collectionsSumExtended_info( $c_id = 0, $news_ids = 0 ) {
  	global $db, $config;	
  
  	if( !$config['collections_extended_info'] ) return false;
  
    if( $c_id ) {

        $news_read = $db->super_query("SELECT sum(e.news_read) as sum_read, sum(e.rating) as sum_rating, sum(e.vote_num) as sum_vote, sum(p.comm_num) as sum_comm FROM `".PREFIX."_post` p LEFT JOIN `".PREFIX."_post_extras` e ON (p.id=e.news_id) WHERE id IN({$news_ids})");
		
        $sum_info = array();
        
        if( $news_read['sum_read'] ) 	$sum_info[] = "news_read = '{$news_read['sum_read']}'";
        if( $news_read['sum_rating'] ) 	$sum_info[] = "sum_rating = '{$news_read['sum_rating']}'";
        if( $news_read['sum_vote'] ) 	$sum_info[] = "sum_vote = '{$news_read['sum_vote']}'";
        if( $news_read['sum_comm'] ) 	$sum_info[] = "sum_comm = '{$news_read['sum_comm']}'";
        
        
        if( count($sum_info) ) {
          
			$sum_info = implode(', ', $sum_info);
          	$db->query( "UPDATE " . PREFIX . "_news_collections SET {$sum_info} WHERE id = '{$c_id}'" );

        }  

    } else {

      $sql = $db->super_query("SELECT id, news_ids, current_tags, current_xfields FROM `".PREFIX."_news_collections`", true);

      foreach( $sql as $row ) {
        
        if( !$row['news_ids'] OR !$row['current_tags'] OR !$row['current_xfields'] ) continue;
        
        $wh = array();
        if( $row['news_ids'] ) $wh[] = "id IN({$row['news_ids']})";
        elseif($row['current_tags'] ) $wh[] = "tags LIKE '%{$val}%'";
        elseif($row['current_xfields'] ) $wh[] = "xfields LIKE '%{$val}%'";
        
        $news_read = $db->super_query("SELECT sum(e.news_read) as sum_read, sum(e.rating) as sum_rating, sum(e.vote_num) as sum_vote, sum(p.comm_num) as sum_comm FROM `".PREFIX."_post` p LEFT JOIN `".PREFIX."_post_extras` e ON (p.id=e.news_id) WHERE {$wh}");        
		
        $sum_info = array();
        
        if( $news_read['sum_read'] ) 	$sum_info[] = "news_read = '{$news_read['sum_read']}'";
        if( $news_read['sum_rating'] ) 	$sum_info[] = "sum_rating = '{$news_read['sum_rating']}'";
        if( $news_read['sum_vote'] ) 	$sum_info[] = "sum_vote = '{$news_read['sum_vote']}'";
        if( $news_read['sum_comm'] ) 	$sum_info[] = "sum_comm = '{$news_read['sum_comm']}'";
        
        
        if( count($sum_info) ) {
          
			$sum_info = implode(', ', $sum_info);
          	$db->query( "UPDATE " . PREFIX . "_news_collections SET {$sum_info} WHERE id = '{$row['id']}'" );

        }

      }

    }
  
}]]></replacecode>
		</operation>
	</file>
	<file name="engine/modules/cron.php">
		<operation action="before">
			<searchcode><![CDATA[clear_cache();]]></searchcode>
			<replacecode><![CDATA[collectionsSumExtended_info();]]></replacecode>
		</operation>
	</file>
	<file name="engine/inc/addnews.php">
		<operation action="after">
			<searchcode><![CDATA[$category_list = $db->safesql( implode( ',', $category_list ) );]]></searchcode>
			<replacecode><![CDATA[if( !is_array($_POST['collections_list']) ) $_POST['collections_list'] = array ();
		
if( !count( $_POST['collections_list'] ) ) {
			
	$c_list = array ();
	$c_list[] = '0';
			
} else $c_list = $_POST['collections_list'];

$collections_list = array();
	
foreach ( $c_list as $value ) {
	$collections_list[] = intval($value);
}

$c_list = $collections_list;
$collections_list = $db->safesql( implode( ',', $collections_list ) );

$c_allow = $user_group[$member_id['user_group']]['collections_allow_edit'];

if( count($c_list) AND $c_list[0] != 0 ) {

	if( !$c_allow AND $member_id['user_group'] != "1" ) {
		msg( "error", array('javascript:history.go(-1)' => $lang['addnews'], '' => $lang['addnews_error'] ), "Вы не можете указывать новостям подборки.", "javascript:history.go(-1)" );
	}

}]]></replacecode>
		</operation>
		<operation action="replace">
			<searchcode><![CDATA[category, alt_name,]]></searchcode>
			<replacecode><![CDATA[category, alt_name, collections,]]></replacecode>
		</operation>
		<operation action="replace">
			<searchcode><![CDATA['$category_list', '$alt_name',]]></searchcode>
			<replacecode><![CDATA['$category_list', '$alt_name', '$collections_list',]]></replacecode>
		</operation>
		<operation action="before">
			<searchcode><![CDATA[clear_cache( array('news_', 'tagscloud_', 'archives_', 'calendar_', 'topnews_', 'rss', 'stats') );]]></searchcode>
			<replacecode><![CDATA[if( count($c_list) AND $c_list[0] != 0 ) {
  
  foreach( $c_list as $val ) {
    
    if( $val ) {
    
      $getCollection = $db->super_query("SELECT news_ids FROM ".PREFIX."_news_collections WHERE id = '{$val}'");	

      if( $getCollection['news_ids'] ) {
        
          $tmp_c = explode(',', $getCollection['news_ids']);
          $tmp_c[] = $id;
          $c_list = implode(',', $tmp_c);
        
      } else $c_list = $id;

      @unlink( ENGINE_DIR . '/cache/system/collections.php' );
      @unlink( ENGINE_DIR . '/cache/system/collections_title/collections_title_'.$val.'.php' );
      clear_cache( array('collections_news_', 'cblock_list_', 'collection_block_') );
      $db->query("UPDATE ".PREFIX."_news_collections SET date = '{$thistime}', num_elem = num_elem+1, news_ids = '{$c_list}' WHERE id = '{$val}'");
  	  
      collectionsSumExtended_info($val, $c_list);
      
    }
    
  }
  
}]]></replacecode>
		</operation>
		<operation action="after">
			<searchcode><![CDATA[$categories_list = CategoryNewsSelection( 0, 0 );]]></searchcode>
			<replacecode><![CDATA[$collections_info = get_vars ( "collections" );

if (!is_array ( $collections_info )) {
	$collections_info = array ();

	$db->query ( "SELECT id, user_name, name, alt_url, descr, num_elem, news_read, news_comm, news_vote, news_rating, date, create_date, cover, news_ids, current_tags, current_xfields, xfields_s, tags_s FROM " . PREFIX . "_news_collections ORDER BY id ASC" );
	while ( $row = $db->get_row () ) {

		$collections_info[$row['id']] = array ();

		foreach ( $row as $key => $value ) {
			$collections_info[$row['id']][$key] = stripslashes ( $value );
		}

	}
	set_vars ( "collections", $collections_info );
	$db->free ();
}

foreach( $collections_info as $val ) {
 	$c_opt .= '<option value="'.$val['id'].'">'.$val['name'].'</option>';
}]]></replacecode>
		</operation>
		<operation action="after">
			<searchcode><![CDATA[ <div class="form-group">
  <label class="control-label col-sm-2">{$lang['addnews_cat']}</label>
  <div class="col-sm-10">
	<select data-placeholder="{$lang['addnews_cat_sel']}" title="{$lang['addnews_cat_sel']}" name="category[]" id="category" onchange="onCategoryChange(this)" $category_multiple style="width:100%;max-width:350px;">{$categories_list}</select>
  </div>
</div>]]></searchcode>
			<replacecode><![CDATA[ <div class="form-group">
  <label class="control-label col-sm-2">Подборки:</label>
  <div class="col-sm-10">
	<select data-placeholder="Выберите подборки..." title="Выберите подборки..." name="collections_list[]" id="collections" class="categoryselect" multiple style="width:100%;max-width:350px;">{$c_opt}</select>
  </div>
</div>]]></replacecode>
		</operation>
		<operation action="after">
			<searchcode><![CDATA[$('.categoryselect').chosen({no_results_text: '{$lang['addnews_cat_fault']}'});]]></searchcode>
			<replacecode><![CDATA[$('#collections').chosen({no_results_text: 'Подборок не найдено'});]]></replacecode>
		</operation>
	</file>
	<file name="engine/classes/google.class.php">
		<operation action="before">
			<searchcode><![CDATA[function get_categories() {]]></searchcode>
			<replacecode><![CDATA[function get_collections() {
	global $db, $user_group;
		
	$collections_info = get_vars( "collections" );
	$this->priority = $this->collections_priority;
		
    if (!is_array ( $collections_info )) {
        $collections_info = array ();

        $db->query ( "SELECT id, user_name, name, alt_url, descr, num_elem, news_read, news_comm, news_vote, news_rating, date, create_date, cover, news_ids, current_tags, current_xfields FROM " . PREFIX . "_news_collections ORDER BY id ASC" );
        while ( $row = $db->get_row () ) {

            $collections_info[$row['id']] = array ();

            foreach ( $row as $key => $value ) {
                $collections_info[$row['id']][$key] = stripslashes ( $value );
            }

        }
        set_vars ( "collections", $collections_info );
        $db->free ();
    }
		
	$xml = "";
	$lastmod = date( "Y-m-d" );
		
	//$allow_list = explode ( ',', $user_group[5]['allow_cats'] );
	//$not_allow_cats = explode ( ',', $user_group[5]['not_allow_cats'] );
		
	foreach ( $collections_info as $row ) {
			
		//if ($allow_list[0] != "all") {
		//	if (!$user_group[5]['allow_short'] AND !in_array( $cats['id'], $allow_list )) continue;
		//}
			
		//if ($not_allow_cats[0] != "") {
		//	if (!$user_group[5]['allow_short'] AND in_array( $cats['id'], $not_allow_cats )) continue;
		//}
			
		if( $this->allow_url ) $loc = $this->home . $row['id'] . '-' . $row['alt_url'];
		else $loc = $this->home . "index.php?do=collections&id=" . $row['id'];
			
		$xml .= $this->get_xml( $loc, $lastmod );
	}
		
	return $xml;
}]]></replacecode>
		</operation>
		<operation action="before">
			<searchcode><![CDATA[$map .= $this->get_news();]]></searchcode>
			<replacecode><![CDATA[$map .= $this->get_collections();]]></replacecode>
		</operation>
	</file>
	<file name="engine/modules/show.custom.php">
		<operation action="after">
			<searchcode><![CDATA[while ( $row = $db->get_row( $sql_result ) ) {]]></searchcode>
			<replacecode><![CDATA[if( !$row['collections'] ) {
  
  	if( $row['tags'] OR $row['xfields'] ) search_collections();
  	else {
      
        $tpl->set( '{collections-link}', $config['collection_speedbar'] . ': Не заданы' );
        $tpl->set( '{collections}', $config['collection_speedbar'] . ': Не заданы' );
      	$tpl->set( '{owner-cnews-list}', '' );
        $tpl->set_block( "'\\[not-collections\\](.*?)\\[/not-collections\\]'si", "" );
      
    }
  
} else {
			
	$collections_text = array ();
	$collections_link = array ();
	$collections_list = explode( ',', $row['collections'] );
	$config['collection_separator'] = $config['collection_separator'] ? $config['collection_separator'] : ',';	
  
  	search_collections(1);

    $tpl->set( '{collections-link}', $config['collection_speedbar'] . ': ' . implode( " {$config['collection_separator']} ", $collections_link ) );
   	$tpl->set( '{collections}', $config['collection_speedbar'] . ': ' . implode( " {$config['collection_separator']} ", $collections_text ) );
  	$tpl->set( '[not-collections]', "" );
	$tpl->set( '[/not-collections]', "" );

}]]></replacecode>
		</operation>
	</file>
</dleplugin>
